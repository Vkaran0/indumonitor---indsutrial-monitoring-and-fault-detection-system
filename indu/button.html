<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FAULT IoT Control Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="button.css">
</head>
<body>

  <!-- NAVBAR -->
  <nav class="navbar">
    <div class="brand">FAULT Dashboard</div>

    <div class="nav-right">
      <div class="nav-state" id="navSystemState">System: Loading...</div>
      <button id="errorNavButton" class="nav-error-btn" onclick="scrollToError()">⚠ ERROR</button>
    </div>
  </nav>


  <div class="container">

    <!-- MACHINE POWER AUTO THRESHOLD -->
    <section class="section">
      <h2>Machine Power Rating</h2>
      <small>Enter power rating to auto-set safety thresholds</small>

      <div style="margin-top:12px;">
        <label style="opacity:0.7;font-size:13px;">Machine Power (Watts)</label>
        <input id="machinePowerInput"
               type="number"
               placeholder="e.g. 1500"
               style="width:220px;padding:8px;border-radius:10px;border:1px solid #b8bfd1;background:#fff;color:#000;">
      </div>

      <button class="btn-primary" onclick="autoSetThresholds()">Auto-Set Thresholds</button>
      <div id="autoSetMsg" style="font-size:12px;opacity:0.7;margin-top:6px;"></div>
    </section>


    <!-- SUMMARY SECTION -->
    <section class="section">
      <h2>System Summary</h2>
      <small>Relay, RF channel, manual operations</small>

      <div class="summary-grid">

        <div class="summary-card">
          <div class="summary-label">Relay Status</div>
          <div class="summary-value">
            <span id="relayStatusText">--</span>
            <span id="relayStatusBadge" class="badge badge-normal">--</span>
          </div>
        </div>

        <div class="summary-card">
          <div class="summary-label">RF Channel</div>
          <div class="summary-value" id="rfChannelText">--</div>
          <input id="rfChannelInput" placeholder="new channel"
                 style="margin-top:8px;padding:6px;border-radius:10px;border:1px solid #b8bfd1;">
          <button onclick="updateRFChannel()" class="btn-secondary">Update</button>
        </div>

        <div class="summary-card">
          <div class="summary-label">Relay Manual Control</div>
          <button onclick="forceRelay('fault')" class="btn-danger" style="margin-top:8px;">Set Fault</button>
          <button onclick="forceRelay('normal')" class="btn-secondary">Set Normal</button>
        </div>

      </div>
    </section>


    <!-- LIVE SENSOR SECTION -->
    <section class="section">
      <h2>Live Sensor Readings</h2>
      <small>Latest readings from Supabase</small>

      <div class="sensor-grid">

        <div class="sensor-card"><div class="sensor-name">Temperature (°C)</div><div id="valTemperature" class="sensor-value">--</div></div>
        <div class="sensor-card"><div class="sensor-name">Humidity (%)</div><div id="valHumidity" class="sensor-value">--</div></div>

        <div class="sensor-card"><div class="sensor-name">Current (A)</div><div id="valCurrent" class="sensor-value">--</div></div>
        <div class="sensor-card"><div class="sensor-name">Voltage (V)</div><div id="valVoltage" class="sensor-value">--</div></div>

        <div class="sensor-card"><div class="sensor-name">Fire</div><div id="valFire" class="sensor-value">--</div></div>
        <div class="sensor-card"><div class="sensor-name">MQ135</div><div id="valMQ135" class="sensor-value">--</div></div>

        <div class="sensor-card"><div class="sensor-name">Magnet</div><div id="valHall" class="sensor-value">--</div></div>
        <div class="sensor-card"><div class="sensor-name">IR Object</div><div id="valIR" class="sensor-value">--</div></div>

      </div>
    </section>


    <!-- THRESHOLD SETTINGS -->
    <section class="section">
      <h2>Threshold Settings</h2>
      <small>Auto-fault triggers when value crosses threshold</small>

      <div class="threshold-grid">

        <div class="threshold-item">
          <label>Temperature (°C)</label>
          <input id="th_temperature" type="number">
        </div>

        <div class="threshold-item">
          <label>Humidity (%)</label>
          <input id="th_humidity" type="number">
        </div>

        <div class="threshold-item">
          <label>Current (A)</label>
          <input id="th_current" type="number">
        </div>

        <div class="threshold-item">
          <label>Voltage (V)</label>
          <input id="th_voltage" type="number">
        </div>

        <div class="threshold-item">
          <label>Fire (0/1)</label>
          <input id="th_fire" type="number">
        </div>

        <div class="threshold-item">
          <label>MQ135 ADC</label>
          <input id="th_mq135" type="number">
        </div>

      </div>

      <button class="btn-primary" onclick="saveThresholds()">Save Thresholds</button>
      <button class="btn-secondary" onclick="loadThresholds()">Reload</button>

      <div id="thresholdMessage" style="font-size:12px;opacity:0.7;margin-top:6px;"></div>
    </section>


    <!-- FAULT / ERROR PANEL -->
    <section class="section" id="errorSection">
      <h2>Fault Panel</h2>
      <small>Shows reason for FAULT</small>

      <p style="margin-top:6px;font-size:13px;">
        System Status: <strong id="systemStatusLabel">Loading...</strong>
      </p>

      <ul class="error-list" id="errorReasonList">
        <li>Waiting for sensor data...</li>
      </ul>

      <button class="btn-danger" onclick="clearFault()">Restore Normal (Activate)</button>

      <p style="font-size:11px;opacity:0.6;margin-top:6px;">
        System will NOT refault until values become normal again and THEN cross threshold.
      </p>
    </section>


  </div>

<script>
    const client = supabase.createClient(
 "https://noyfimgffaccelemollp.supabase.co",
 "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5veWZpbWdmZmFjY2VsZW1vbGxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDM1NTMsImV4cCI6MjA4MDA3OTU1M30.xhjHnWFpLxpFVnMStu2kveN4Ch_qtabNT5FUIIAJw7o"
);

let thresholds = {};
let lastErrorReasons = [];
let currentRelayStatus = "normal";
let faultMode = "idle"; // idle → fault → hold

/* --------------------- UI Helpers --------------------- */
function setText(id, value) {
  let el = document.getElementById(id);
  if (el) el.textContent = value;
}

function scrollToError() {
  document.getElementById("errorSection").scrollIntoView({ behavior:"smooth" });
}

function updateErrorUI(isFault) {
  let btn = document.getElementById("errorNavButton");
  let badge = document.getElementById("relayStatusBadge");

  if (isFault) {
    btn.style.display = "inline-block";
    badge.textContent = "FAULT";
    badge.className = "badge badge-fault";
    setText("navSystemState","System: FAULT");
    setText("systemStatusLabel","FAULT");
  } else {
    btn.style.display = "none";
    badge.textContent = "NORMAL";
    badge.className = "badge badge-normal";
    setText("navSystemState","System: NORMAL");
    setText("systemStatusLabel","NORMAL");
  }
}

function renderErrorReasons() {
  let ul = document.getElementById("errorReasonList");
  ul.innerHTML = "";
  if (lastErrorReasons.length === 0) {
    ul.innerHTML = "<li>No active fault</li>";
    return;
  }
  lastErrorReasons.forEach(r => {
    let li = document.createElement("li");
    li.textContent = r;
    ul.appendChild(li);
  });
}


/* --------------------- Auto Threshold from Power Rating --------------------- */
function autoSetThresholds() {
  let W = parseFloat(document.getElementById("machinePowerInput").value);

  if (isNaN(W) || W <= 0) {
    document.getElementById("autoSetMsg").textContent = "Enter valid watt rating.";
    return;
  }

  // Auto formulas
  let ratedCurrent = W / 230;
  let maxCurrent = ratedCurrent * 1.30;
  let maxVoltage = 250;
  let maxTemp = 65;
  let maxHumidity = 85;
  let fireTh = 0;
  let mq135Th = 600;

  // Fill fields
  document.getElementById("th_current").value = maxCurrent.toFixed(1);
  document.getElementById("th_voltage").value = maxVoltage;
  document.getElementById("th_temperature").value = maxTemp;
  document.getElementById("th_humidity").value = maxHumidity;
  document.getElementById("th_fire").value = fireTh;
  document.getElementById("th_mq135").value = mq135Th;

  document.getElementById("autoSetMsg").textContent =
    "Thresholds updated based on machine rating!";
}


/* --------------------- Threshold Load/Save --------------------- */
async function loadThresholds() {
  setText("thresholdMessage","Loading thresholds...");

  const { data } = await client.from("thresholds").select("*");

  data.forEach(row => thresholds[row.sensor_name] = row.threshold);

  for (let key of ["temperature","humidity","current","voltage","fire","mq135"]) {
    let el = document.getElementById("th_"+key);
    if (el) el.value = thresholds[key];
  }

  setText("thresholdMessage","Thresholds loaded.");
}

async function saveThresholds() {
  let names = ["temperature","humidity","current","voltage","fire","mq135"];
  let payload = [];

  names.forEach(name=>{
    let el = document.getElementById("th_"+name);
    let v = parseFloat(el.value);
    if (!isNaN(v)) {
      payload.push({ sensor_name:name, threshold:v });
      thresholds[name] = v;
    }
  });

  await client.from("thresholds").upsert(payload, { onConflict:"sensor_name" });
  setText("thresholdMessage","Thresholds saved.");
}


/* --------------------- Fault Mode Load/Save --------------------- */
async function loadFaultMode() {
  let { data } = await client
    .from("system_state")
    .select("*")
    .eq("key","fault_mode")
    .maybeSingle();

  if (!data) {
    await client.from("system_state").insert({ key:"fault_mode", value:"idle" });
    faultMode = "idle";
  } else {
    faultMode = data.value || "idle";
  }
}

async function setFaultMode(m) {
  faultMode = m;
  await client.from("system_state")
    .upsert({ key:"fault_mode", value:m });
}


/* --------------------- Relay & RF --------------------- */
async function loadRelayRF() {
  let relay = await client.from("relay_status").select("*").eq("id",1).single();
  let rf = await client.from("rf_channel_control").select("*").eq("id",1).single();

  if (relay.data) {
    currentRelayStatus = relay.data.status;
    setText("relayStatusText", relay.data.status.toUpperCase());
    updateErrorUI(relay.data.status === "fault");
  }

  if (rf.data) setText("rfChannelText", rf.data.channel);
}

async function forceRelay(state) {
  await client.from("relay_status").update({status:state}).eq("id",1);
  currentRelayStatus = state;
  updateErrorUI(state === "fault");
  setText("relayStatusText", state.toUpperCase());
}

async function updateRFChannel() {
  let val = parseInt(document.getElementById("rfChannelInput").value);
  if (isNaN(val)) return alert("Invalid channel");
  await client.from("rf_channel_control").update({channel:val}).eq("id",1);
  setText("rfChannelText", val);
}


/* --------------------- Fault Logic --------------------- */
async function evaluateFault(snapshot) {
  let r = [];

  if (snapshot.temperature > thresholds.temperature)
    r.push(`Temperature ${snapshot.temperature} > ${thresholds.temperature}`);

  if (snapshot.current > thresholds.current)
    r.push(`Current ${snapshot.current} > ${thresholds.current}`);

  if (snapshot.voltage > thresholds.voltage)
    r.push(`Voltage ${snapshot.voltage} > ${thresholds.voltage}`);

  if (snapshot.fire > thresholds.fire)
    r.push(`Fire detected (${snapshot.fire})`);

  if (snapshot.mq135 > thresholds.mq135)
    r.push(`MQ135 ${snapshot.mq135} > ${thresholds.mq135}`);

  let cross = r.length > 0;

  if (faultMode === "idle") {
    if (cross) {
      lastErrorReasons = r;
      renderErrorReasons();
      await forceFault();
    }
  }

  else if (faultMode === "fault") {
    if (cross) {
      lastErrorReasons = r;
      renderErrorReasons();
    }
  }

  else if (faultMode === "hold") {
    if (!cross) {
      await setFaultMode("idle");
    }
  }
}

async function forceFault() {
  await client.from("relay_status").update({status:"fault"}).eq("id",1);
  currentRelayStatus = "fault";
  updateErrorUI(true);
  await setFaultMode("fault");
}


/* --------------------- Clear Fault --------------------- */
async function clearFault() {
  await client.from("relay_status").update({status:"normal"}).eq("id",1);
  currentRelayStatus = "normal";
  updateErrorUI(false);
  lastErrorReasons = [];
  renderErrorReasons();
  await setFaultMode("hold");
}


/* --------------------- Live Sensor Fetch --------------------- */
async function loadLiveData() {
  let [dht, fire, hall, ir, mq, iv] = await Promise.all([
    client.from("dht11_readings").select("*").order("created_at",{ascending:false}).limit(1),
    client.from("fire_readings").select("*").order("created_at",{ascending:false}).limit(1),
    client.from("hall_readings").select("*").order("created_at",{ascending:false}).limit(1),
    client.from("ir_readings").select("*").order("created_at",{ascending:false}).limit(1),
    client.from("mq135_readings").select("*").order("created_at",{ascending:false}).limit(1),
    client.from("readings").select("*").order("created_at",{ascending:false}).limit(1)
  ]);

  let t = dht.data?.[0]?.temperature ?? "--";
  let h = dht.data?.[0]?.humidity ?? "--";
  let A = iv.data?.[0]?.current ?? "--";
  let V = iv.data?.[0]?.voltage ?? "--";
  let F = fire.data?.[0]?.fire_detected ?? "--";
  let MQ = mq.data?.[0]?.adc_value ?? "--";
  let HL = hall.data?.[0]?.magnet_present ?? "--";
  let IR = ir.data?.[0]?.object_present ?? "--";

  setText("valTemperature", t);
  setText("valHumidity", h);
  setText("valCurrent", A);
  setText("valVoltage", V);
  setText("valFire", F);
  setText("valMQ135", MQ);
  setText("valHall", HL);
  setText("valIR", IR);

  if (t !== "--" && A !== "--") {
    await evaluateFault({
      temperature: parseFloat(t),
      humidity: parseFloat(h),
      current: parseFloat(A),
      voltage: parseFloat(V),
      fire: parseFloat(F),
      mq135: parseFloat(MQ)
    });
  }
}


/* --------------------- INIT --------------------- */
async function init() {
  await loadFaultMode();
  await loadThresholds();
  await loadRelayRF();
  await loadLiveData();

  setInterval(loadLiveData, 4000);
}

init();
</script>

</body>
</html>
